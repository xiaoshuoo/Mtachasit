{% extends 'blog/base.html' %}
{% load static %}

{% block title %}Лекции{% endblock %}

{% block content %}
<div class="max-w-[1400px] mx-auto p-6">
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 rounded-xl glass-card flex items-center justify-center rotate-6">
        <i class="fas fa-chalkboard-teacher text-xl text-purple-300"></i>
      </div>
      <div>
        <h1 class="text-3xl font-bold">Лекции{% if selected_category %} — {{ selected_category.name }}{% endif %}</h1>
        <p class="text-gray-400">Управление текстовыми лекциями</p>
      </div>
    </div>
    <div class="hidden md:block w-full max-w-sm">
      <div class="relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <input id="lecture-search" placeholder="Поиск лекций..." class="w-full pl-10 pr-3 py-2 rounded-lg glass-card outline-none" />
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-[260px_minmax(0,1fr)] gap-6">
    <!-- Sidebar -->
    <aside class="glass-card rounded-2xl p-4 h-max sticky top-6">
      <nav class="space-y-2">
        <a href="{% url 'blog:lectures' %}" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white/5 transition {{ not selected_category|yesno:'','bg-white/5 font-semibold' }}">
          <i class="fas fa-list"></i>
          <span>Все лекции</span>
        </a>
        {% for category in categories %}
        <a href="?category={{ category.slug }}" class="flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-white/5 transition {% if selected_category and selected_category.slug == category.slug %}bg-white/5 font-semibold{% endif %}">
          <i class="{{ category.icon|default:'fas fa-folder' }} text-purple-300"></i>
          <span class="truncate">{{ category.name }}</span>
        </a>
        {% endfor %}
      </nav>
    </aside>

    <!-- Content -->
    <section class="space-y-3" id="lectures-container">
      {% for lecture in lectures %}
      <div class="lecture-card glass-card rounded-2xl overflow-hidden" data-lecture-title="{{ lecture.title|lower }}" id="lecture-card-{{ lecture.id }}">
        <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between cursor-pointer" onclick="toggleLecture('lecture-{{ lecture.id }}')">
          <div class="flex items-center gap-3 min-w-0">
            <div class="w-8 h-8 rounded-lg bg-purple-500/10 border border-purple-500/20 flex items-center justify-center text-purple-300 font-bold">{{ forloop.counter }}</div>
            <h3 class="text-lg font-semibold truncate">{{ lecture.title }}</h3>
          </div>
          <i id="icon-lecture-{{ lecture.id }}" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
        </div>
        <div id="lecture-{{ lecture.id }}" class="hidden">
          <div class="flex justify-end gap-2 px-4 py-3">
            <button onclick="copyFullLecture('{{ lecture.id }}')" class="px-3 py-2 rounded-lg glass-card text-purple-200 hover:bg-white/10"><i class="fas fa-copy mr-2"></i>Копировать всё</button>
            {% if user.is_staff %}
            <form action="{% url 'blog:delete_lecture' lecture.id %}" method="post" onsubmit="return confirm('Удалить лекцию?')">{% csrf_token %}
              <button class="px-3 py-2 rounded-lg glass-card text-red-300 hover:bg-red-500/10"><i class="fas fa-trash mr-2"></i>Удалить</button>
            </form>
            {% endif %}
          </div>
          <div class="px-4 pb-4">
            <div class="content-area rounded-xl p-3 space-y-1">
              {% with lines=lecture.content|linebreaksbr|split:'<br>' %}
              {% for line in lines %}
              {% if line|striptags|trim != '' %}
              <div class="line-hover p-2 rounded-lg flex items-center gap-2 cursor-pointer" onclick="copyLineToClipboard('{{ line|striptags|escapejs }}', this)" data-copied="false">
                <span class="w-5 h-5 flex items-center justify-center rounded-md bg-purple-500/5 text-purple-400/70 text-xs border border-purple-500/10">{{ forloop.counter }}</span>
                <span class="lecture-line-text font-mono text-sm text-gray-200">{{ line|safe }}</span>
                <span class="ml-auto hidden group-hover:block text-xs text-purple-300">Скопировать</span>
                <span class="copy-success hidden ml-2 text-green-400 text-xs">✓ Скопировано!</span>
              </div>
              {% endif %}
              {% endfor %}
              {% endwith %}
            </div>
          </div>
        </div>
      </div>
      {% empty %}
        <div class="glass-card p-10 rounded-2xl text-center text-gray-300">Лекций пока нет</div>
      {% endfor %}
    </section>
  </div>
</div>

<script>
function decodeHtmlEntities(text){const t=document.createElement('textarea');t.innerHTML=text;return t.value}
function copyLineToClipboard(raw, el){const txt=decodeHtmlEntities(raw);if(el.getAttribute('data-copied')==='true'){el.classList.remove('copied-highlight');el.setAttribute('data-copied','false');return}navigator.clipboard.writeText(txt).then(()=>{el.classList.add('copied-highlight');el.setAttribute('data-copied','true');}).catch(()=>{const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);el.classList.add('copied-highlight');el.setAttribute('data-copied','true');});}
function copyFullLecture(id){const area=document.querySelector('.lecture-content-'+id)||document.querySelector('#lecture-card-'+id);const lines=(area?.querySelectorAll('.lecture-line-text')||[]);let out='';lines.forEach(s=>{out+=(s.textContent||'').trim()+"\n"});navigator.clipboard.writeText(out.trim())}
function toggleLecture(id){const c=document.getElementById(id);const i=document.getElementById('icon-'+id);if(c.classList.contains('hidden')){c.classList.remove('hidden');if(i)i.style.transform='rotate(180deg)'}else{c.classList.add('hidden');if(i)i.style.transform='rotate(0deg)'}}
document.addEventListener('DOMContentLoaded',()=>{const s=document.getElementById('lecture-search');if(s){s.addEventListener('input',e=>{const q=e.target.value.toLowerCase();document.querySelectorAll('.lecture-card').forEach(card=>{const t=card.getAttribute('data-lecture-title')||'';card.style.display=t.includes(q)?'':'none'})})}})
</script>
{% endblock %}


